server:
  port: ${PORT}
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/plain,text/css,text/javascript,application/javascript
    min-response-size: 1KB
    excluded-user-agents: MSIE 6.0,UCBrowser
  undertow:
    threads:
      io: 4                         # Рекомендуется = число ядер CPU
      worker: 100                    # 20-25 на ядро (4 ядра * 25 = 100)
    buffer-size: 32KB               # Увеличим для больших ответов
    direct-buffers: true
    no-request-timeout: 30s         # Уменьшим таймаут

#========= Spring =========#
spring:
  application:
    name: MadeInRussia
  servlet:
    multipart:
      max-file-size: ${UPLOADING_MAX_FILE_SIZE}
      max-request-size: ${UPLOADING_MAX_REQUEST_SIZE}
      enabled: true
  mvc:

    #========= Cors =========#
    cors:
      allowed-origins: ${CORS_ALLOWED_ORIGINS}
      allowed-methods: ${CORS_ALLOWED_METHODS}
      allowed-headers: ${CORS_ALLOWED_HEADERS}
      allow-credentials: ${CORS_ALLOW_CREDENTIALS}
      max-age: ${CORS_MAX_AGE}

  #========= Datasource =========#
  datasource:
    url: ${POSTGRES_URL}
    username: ${POSTGRES_USERNAME}
    password: ${POSTGRES_PASSWORD}
    driver-class-name: org.postgresql.Driver

    #========= Hikari Pool =========#
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 3000
      leak-detection-threshold: 20000
      auto-commit: false
      idle-timeout: 30000
  jpa:
    open-in-view: ${JPA_OPEN_IN_VIEW}
    properties:
      hibernate:
        connection.provider_disables_autocommit: true
        generate_statistics: false # Для мониторинга
        order_inserts: true       # Оптимизация batch-операций
        order_updates: true
        jdbc:
          batch_size: 20          # Размер batch-операций
          fetch_size: 100         # Размер выборки для ResultSet
        query:
          in_clause_parameter_padding: true # Оптимизация IN-условий
  flyway:
    url: ${POSTGRES_URL}
    user: ${POSTGRES_USERNAME}
    password: ${POSTGRES_PASSWORD}

  data:
  #========= Redis =========#
    redis:
      host: ${REDIS_HOST}
      port: 6379
      database: 0
      repositories:
        enabled: false

  #========= OAuth 2.0 =========#
  security:
    oauth2:
      client:
        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://openidconnect.googleapis.com/v1/userinfo
            jwk-set-uri: https://www.googleapis.com/oauth2/v3/certs
            user-name-attribute: sub
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope:
             - email
             - profile
            client-name: Google

  #========= Mail =========#
  mail:
    host: ${MAIL_HOST}
    port: ${MAIL_PORT}
    username: ${MAIL_USERNAME}
    password: ${MAIL_PASSWORD}
    properties:
      mail:
        transport:
          protocol: smtps
        smtp:
          port: 25
          auth: true
          starttls:
            enable: true
            required: true

  #========== Localization ==========#
  messages:
    basename: messages/messages
    encoding: UTF-8

#========= Management =========#
management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: health, info, metrics, prometheus, ratelimit
      base-path: /actuator

#========= Logging =========#
logging:
  level:
    root: ${LOG_LEVEL}

#========= JWT =========#
jwt:
  access-token:
    secret: ${JWT_ACCESS_TOKEN_SECRET}
    lifetime: ${JWT_ACCESS_TOKEN_LIFETIME}
  refresh-token:
    secret: ${JWT_REFRESH_TOKEN_SECRET}
    lifetime: ${JWT_REFRESH_TOKEN_LIFETIME}

#========== App environments ==========#
app:
  rate:
    limit:
      capacity: ${RATE_LIMIT_CAPACITY}
      whitelist: ${RATE_LIMIT_WHITE_LIST}
      refill:
        tokens: ${RATE_LIMIT_REFILL_TOKENS}
        seconds: ${RATE_LIMIT_REFILL_SECONDS}
  session:
    secret: ${INTERNAL_REQUEST_SECRET}
  redis:
    ttl-duration: ${REDIS_TTL_DURATION}
    currency-ttl-duration: ${REDIS_CURRENCY_TTL_DURATION}
    verification-ttl-duration: ${REDIS_VERIFICATION_DURATION}
    recover-password-ttl-duration: ${REDIS_RECOVER_PASSWORD_DURATION}
  cloudinary:
    api-key: ${CLOUDINARY_API_KEY}
    api-secret: ${CLOUDINARY_API_SECRET}
    cloud-name: ${CLOUDINARY_CLOUD_NAME}
  compress:
    image:
      max-width: ${IMAGE_COMPRESS_MAX_WIDTH}
      max-height: ${IMAGE_COMPRESS_MAX_HEIGHT}
      quality: ${IMAGE_COMPRESS_QUALITY}
    video:
      max-width: ${VIDEO_COMPRESS_MAX_WIDTH}
      max-height: ${VIDEO_COMPRESS_MAX_HEIGHT}
      quality: ${VIDEO_COMPRESS_QUALITY}
  yandex:
    translate:
      uri: https://translate.api.cloud.yandex.net/translate/v2/translate
      folder-id: ${YANDEX_TRANSLATE_FOLDER_ID}
      secret: ${YANDEX_TRANSLATE_SECRET}
  okved:
    uri: https://agentom.ru/api/okved

telegram:
  bot:
    username: ${BOT_USERNAME}
    token: ${BOT_TOKEN}

springdoc:
  swagger-ui:
    path: /api/swagger-ui/index.html
    config-url: /api/v3/api-docs/swagger-config
    url: /api/v3/api-docs
  api-docs:
    path: /api/v3/api-docs

java:
  opts: >-
    -Xms2048m -Xmx3584m             # Оставляем 1GB для системы
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=150
    -XX:ParallelGCThreads=4
    -XX:ConcGCThreads=2
    -XX:+AlwaysPreTouch
    -XX:+UseStringDeduplication
    -Djava.security.egd=file:/dev/./urandom